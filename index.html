<!DOCTYPE html>
<html>
<head>
  <title>Polytopia</title>

</head>

<body>
  <h1>Polytopia transaction generator and signer</h1>
    
<select onchange="viewMethod(this)">
<option value="register">register</option>
<option value="immigrate">immigrate</option>    
<option value="shuffle">shuffle</option>    
<option value="vote">vote</option>    
<option value="verify">verify</option>
<option value="completeVerification">completeVerification</option>
<option value="claimPersonhood">claimPersonhood</option>    
<option value="dispute">dispute</option>    
<option value="reassign">ressign</option>    
<option value="transfer">transfer</option>    
</select>

<div id="method"></div>    
    
<template id="register">
    <button onclick="register()">register</button>
</template>    
<template id="immigrate">
    <button onclick="immigrate()">immigrate</button>
</template>    
<template id="shuffle">
    <button onclick="shuffle()">shuffle</button>
</template>    
<template id="vote">
    <input id="_id" type="number" placeholder="_id"><button onclick="vote()">vote</button>
</template>
<template id="verify">
    <input id="_account" type="text" placeholder="_account"><button onclick="verify()">verify</button>
</template>
<template id="completeVerification">
    <button onclick="completeVerification()">completeVerification</button>
</template>
<template id="claimPersonhood">
    <button onclick="claimPersonhood()">claimPersonhood</button>
</template>
<template id="dispute">
    <label>Premeet: </label><input id="premeetDispute" type="checkbox"><button onclick="dispute()">dispute</button>
</template>    
<template id="reassign">
    <label>Premeet: </label><input id="premeetReassign" type="checkbox"><button onclick="reassign()">reassign</button>
</template>    
<template id="transfer">
    <input id="_to" placeholder="_to" type="text"><input id="_amount" placeholder="_amount" type="number"><select id="_token"><option value="0">Personhood</option><option value="1">Registration</option><option value="2">Immigration</option></select><button onclick="transfer()">transfer</button>
</template>    

<template id="transactionGenerator">
    <div>
        <label>Transaction data: </label><input id="calldata" type="text" placeholder="0x1b7e...">
    </div>
    <div>
        <label>Nonce: </label><input id="nonce" type="number" placeholder="0" oninput="inputNonce()">
    </div>
    <div id="gasinput" style="display: none">
    <label>Gas: </label><input id="gas" type="number" placeholder="21000" oninput="inputGas()">
    </div>
    <div id="gaspriceinput" style="display: none">
    <label>Gas price: </label><input id="gasprice" type="number" value="5" oninput="inputGasPrice()">
    </div>
    <div id="privatekey" style="display: none">
    <label>Private key: </label><input id="key" type="text" placeholder="Example: 0xe230d63e82551f42a1d00ee75448e01f5370ba387998835415983144a46bd504" size="66"><button onclick="sign()">Sign</button>
    </div>
</template>   

<div id="transaction"></div>
    
<script>
    
    var Polytopia = "0x12528bd2392f12d3d18828436814e41f50639dcd"
    
    var transaction = {
            "to": Polytopia,
            "value": "0",
            "gas": "",
            "gasPrice": "",
            "nonce": "",
            "data": ""
        }
    
    function initiate() {
        loadMethod("register")
    }
    initiate()
    
    function resetMethod() {
        document.getElementById('methodLoaded').remove();
    }
    function loadMethod(_method) {
        var div = document.createElement("div");
        div.id = "methodLoaded";
        document.getElementById("method").appendChild(div);
        var method = document.getElementById(_method);
        var clone = method.content.cloneNode(true)
        document.querySelector('#methodLoaded').appendChild(clone);
    }
    function resetTransaction() {
        if(document.getElementById("transactionLoaded")) document.getElementById('transactionLoaded').remove();
    }
    function loadTransaction() {
        var div = document.createElement("div");
        div.id = "transactionLoaded";
        document.getElementById("transaction").appendChild(div);
        var template = document.getElementById('transactionGenerator');
        var clone = template.content.cloneNode(true)
        document.querySelector('#transactionLoaded').appendChild(clone);
    }
    function generateTransaction() {
        resetTransaction()
        loadTransaction()
    }
    function viewMethod(selectObject) {
        resetMethod()
        resetTransaction()
        loadMethod(selectObject.value)
    }
    
    function sign() {}

    function intToHex(int) {
        if(int == 0) return "80"
        var str = Number(int).toString(16)
        if(str.length%2 == 1) str = '0' + str
        return str
    }
    function rlp_prefix(str) {
        var input_in_bytes = (str.length)/2
        if(input_in_bytes == 1 && Number(str)<128) return str;
		var prefix
        if(input_in_bytes < 56) {
            prefix = intToHex((str.length/2)+128)
            return prefix.concat(str)
        }
        prefix = (intToHex(input_in_bytes).length/2 + 183).toString(16).concat(input_in_bytes.toString(16))
		return prefix.concat(str)
    }
    function rlpEncoded() {
        
        var nonce = rlp_prefix(intToHex(transaction.nonce))
        var gasPrice = rlp_prefix(intToHex(transaction.gasPrice))
        var gas = rlp_prefix(intToHex(transaction.gas))
        var to = rlp_prefix(transaction.to.substring(2))
        var amount = rlp_prefix(intToHex(transaction.value))
        var data = rlp_prefix(transaction.data.substring(2))
        var payload = nonce.concat(gasPrice).concat(gas).concat(to).concat(amount).concat(data)
        return intToHex(192+payload.length/2).concat(payload)
    }
    function transactionData(data, gas) {
        generateTransaction()
        document.getElementById("calldata").value = data
        transaction.data = data
        document.getElementById("calldata").size = data.length
        document.getElementById("gas").value = gas
        transaction.gas = gas
    }
    function inputNonce() {
        transaction.nonce = document.getElementById("nonce").value
        console.log(transaction.nonce)
        document.getElementById("gasinput").style.display = "block"
        document.getElementById("gaspriceinput").style.display = "block"
        document.getElementById("privatekey").style.display = "block"
        inputGas()
        inputGasPrice()
    }
    function inputGas() {
        transaction.gas = document.getElementById("gas").value
    }
    function inputGasPrice() {
        transaction.gasPrice = document.getElementById("gasprice").value*10**9
    }
    function register() {
        transactionData("0x1aa3a008", 115469)
    }
    function immigrate() {
        transactionData("0x0ca3a075", 103617)
    }
    function shuffle() {
        transactionData("0x2520bf04", 163340)
    }
    function vote() {
        var id = Number(document.getElementById("_id").value)
        var data = "0x0121b93f".concat(id.toString(16).padStart(64, 0))
        transactionData(data, 68888)
    }
    function verify() {
        var account = document.getElementById("_account").value
        var data = "0x63a9c3d7".concat(account.padStart(64, 0))
        transactionData(data, 51674)
    }
    function completeVerification() {
        transactionData("0xa128644d", 49285)        
    }
    function claimPersonhood() {
        transactionData("0xd5dffb27", 78773)        
    }    
    function dispute() {
        var premeet = Number(document.getElementById("premeetDispute").checked)
        var data = "0x91ee7bbf".concat(String(premeet).padStart(64, 0))
        transactionData(data, 46398)
    }
    function reassign() {
        var premeet = Number(document.getElementById("premeetReassign").checked)
        var data = "0x62fa2f1f".concat(String(premeet).padStart(64, 0))
        transactionData(data, 24759)
    }
    function transfer() {
        var _to = document.getElementById("_to").value
        var _amount = document.getElementById("_amount").value
        var _token = document.getElementById("_token").value
        var data = "0xdbe58c1f".concat(_to.padStart(64, 0)).concat(_amount.padStart(64, 0)).concat(_token.padStart(64, 0))
        transactionData(data, 51919)
    }
</script>

</body>
</html>
