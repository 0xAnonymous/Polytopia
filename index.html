<html>
<head>
    <title>Polytopia</title>
<!--
<script src="https://github.com/ethereumjs/browser-builds/blob/master/dist/ethereumjs-tx/ethereumjs-tx-1.3.3.min.js"></script>
-->
<script src="https://cdn.jsdelivr.net/gh/ethereumjs/browser-builds/dist/ethereumjs-tx/ethereumjs-tx-1.3.3.min.js"></script>
<script>

</script>
</head>
    
<body>
  <h1>Polytopia transaction generator and signer</h1>
   
 <div id="privatekey">
 <label>Private key: </label><input id="key" type="text" size="66"><button onclick="loadSelector()">Load</button>
 </div>
 <div id="publickey" style="display: none">
 <label>Address: </label><input id="address" type="text" size="42">
 </div>
    
<template id="selector">
<select onchange="viewMethod(this)">
<option value="register">register</option>
<option value="immigrate">immigrate</option>    
<option value="shuffle">shuffle</option>    
<option value="vote">vote</option>    
<option value="verify">verify</option>
<option value="completeVerification">completeVerification</option>
<option value="claimPersonhood">claimPersonhood</option>    
<option value="dispute">dispute</option>    
<option value="reassign">ressign</option>    
<option value="transfer">transfer</option>    
</select>    
</template>

<div id="select"></div>
    
<div id="method"></div>    
 
<template id="register">
    <button onclick="register()">register</button>
</template>    
<template id="immigrate">
    <button onclick="immigrate()">immigrate</button>
</template>    
<template id="shuffle">
    <button onclick="shuffle()">shuffle</button>
</template>    
<template id="vote">
    <input id="_id" type="number" placeholder="_id"><button onclick="vote()">vote</button>
</template>
<template id="verify">
    <input id="_account" type="text" placeholder="_account"><button onclick="verify()">verify</button>
</template>
<template id="completeVerification">
    <button onclick="completeVerification()">completeVerification</button>
</template>
<template id="claimPersonhood">
    <button onclick="claimPersonhood()">claimPersonhood</button>
</template>
<template id="dispute">
    <label>Premeet: </label><input id="premeetDispute" type="checkbox"><button onclick="dispute()">dispute</button>
</template>    
<template id="reassign">
    <label>Premeet: </label><input id="premeetReassign" type="checkbox"><button onclick="reassign()">reassign</button>
</template>    
<template id="transfer">
    <input id="_to" placeholder="_to" type="text"><input id="_amount" placeholder="_amount" type="number"><select id="_token"><option value="0">Personhood</option><option value="1">Registration</option><option value="2">Immigration</option></select><button onclick="transfer()">transfer</button>
</template>        
   

<template id="transactionGenerator">
    <div>
        <label>Transaction data: </label><input id="calldata" type="text" placeholder="0x1b7e...">
    </div>
    <div>
        <label>Nonce: </label><input id="nonce" type="number" placeholder="0" oninput="inputNonce()">
    </div>
    <div id="gasinput" style="display: none">
    <label>Gas: </label><input id="gas" type="number" placeholder="21000" oninput="inputGas()">
    </div>
    <div id="gaspriceinput" style="display: none">
    <label>Gas price: </label><input id="gasprice" type="number" value="5" oninput="inputGasPrice()">
    </div>
    <div id="sign" style="display: none">
    <button onclick="sign()">Sign </button><input id="signature" type="text" style="display:none">
    </div>
</template>      

<div id="transaction"></div>
    
<script>
    
    let privateKey
    let publicKey
    
    var Polytopia = "0x12528bd2392f12d3d18828436814e41f50639dcd"
    
    var transaction = {
            "nonce": "",
            "gasPrice": "",
            "gas": "",
            "to": Polytopia,
            "value": "0",
            "data": ""
        }
    
    function initiate() {
        loadMethod("register")
    }
    function checkforhex(key) {
        if (key[0] == '0' && key[1] == 'x') return true;
        return false;
    }
    function getAddress() {
        let txParams = {
        }
        let tx = new ethereumjs.Tx(txParams)
        tx.sign(privateKey)
        publicKey = tx.from
        document.getElementById("address").value = "0x".concat(publicKey.toString('hex'))
    }
    function loadKey() {
        var pKey = document.getElementById("key").value
        if(checkforhex(pKey) == true) pKey = pKey.substring(2)
        privateKey = new ethereumjs.Buffer.Buffer(pKey, 'hex')
        getAddress()        
    }
    function loadSelector() {
        if(document.getElementById("selectorLoaded")) { 
            document.getElementById('selectorLoaded').remove(); 
            resetMethod()
            document.getElementById("publickey").style.display = "none"
        }
        loadKey()
        if(publicKey==undefined) return

        var div = document.createElement("div");
        div.id = "selectorLoaded";
        document.getElementById("select").appendChild(div);        
        var selector = document.getElementById("selector");
        var clone = selector.content.cloneNode(true)
        document.getElementById('selectorLoaded').appendChild(clone);
        document.getElementById("publickey").style.display = "block"
        initiate()
    }
    function resetMethod() {
        if(document.getElementById("methodLoaded")) document.getElementById('methodLoaded').remove();

    }
    function loadMethod(_method) {
        resetMethod()
        var div = document.createElement("div");
        div.id = "methodLoaded";
        document.getElementById("method").appendChild(div);
        var method = document.getElementById(_method);
        var clone = method.content.cloneNode(true)
        document.querySelector('#methodLoaded').appendChild(clone);
    }
    function resetTransaction() {
        if(document.getElementById("transactionLoaded")) document.getElementById('transactionLoaded').remove();
    }
    function loadTransaction() {
        var div = document.createElement("div");
        div.id = "transactionLoaded";
        document.getElementById("transaction").appendChild(div);
        var template = document.getElementById('transactionGenerator');
        var clone = template.content.cloneNode(true)
        document.querySelector('#transactionLoaded').appendChild(clone);
    }
    function generateTransaction() {
        resetTransaction()
        loadTransaction()
    }
    function viewMethod(selectObject) {
        resetTransaction()
        loadMethod(selectObject.value)
    }
    function transactionData(data, gas) {
        generateTransaction()
        document.getElementById("calldata").value = data
        transaction.data = data
        document.getElementById("calldata").size = data.length
        document.getElementById("gas").value = gas
        transaction.gas = gas
    }
    function inputNonce() {
        transaction.nonce = document.getElementById("nonce").value
        document.getElementById("gasinput").style.display = "block"
        document.getElementById("gaspriceinput").style.display = "block"
        document.getElementById("sign").style.display = "block"
        inputGas()
        inputGasPrice()
    }
    function inputGas() {
        transaction.gas = document.getElementById("gas").value
    }
    function inputGasPrice() {
        transaction.gasPrice = document.getElementById("gasprice").value*10**9
    }
    function intToHex(int) {
        var str = Number(int).toString(16)
        if(str.length%2 == 1) str = '0' + str
        return "0x".concat(str)
    }
    function sign() {
        let txParams = {
            nonce:    intToHex(transaction.nonce),
            gasPrice: intToHex(transaction.gasPrice), 
            gasLimit: intToHex(transaction.gas),
            to:       transaction.to, 
            value:    '0x00',
            data:     transaction.data
        }
        let tx = new ethereumjs.Tx(txParams)
        console.log(tx)
        tx.sign(privateKey)
        let serializedTx = tx.serialize().toString('hex')
        document.getElementById("signature").style.display = "block"
        document.getElementById("signature").value = serializedTx
        document.getElementById("signature").size = serializedTx.length
        console.log('serializedTx:', serializedTx)
    }
    function register() {
        transactionData("0x1aa3a008", 115469)
    }
    function immigrate() {
        transactionData("0x0ca3a075", 103617)
    }
    function shuffle() {
        transactionData("0x2520bf04", 163340)
    }
    function vote() {
        var id = Number(document.getElementById("_id").value)
        var data = "0x0121b93f".concat(id.toString(16).padStart(64, 0))
        transactionData(data, 68888)
    }
    function verify() {
        var account = document.getElementById("_account").value
        var data = "0x63a9c3d7".concat(account.padStart(64, 0))
        transactionData(data, 51674)
    }
    function completeVerification() {
        transactionData("0xa128644d", 49285)        
    }
    function claimPersonhood() {
        transactionData("0xd5dffb27", 78773)        
    }    
    function dispute() {
        var premeet = Number(document.getElementById("premeetDispute").checked)
        var data = "0x91ee7bbf".concat(String(premeet).padStart(64, 0))
        transactionData(data, 46398)
    }
    function reassign() {
        var premeet = Number(document.getElementById("premeetReassign").checked)
        var data = "0x62fa2f1f".concat(String(premeet).padStart(64, 0))
        transactionData(data, 24759)
    }
    function transfer() {
        var _to = document.getElementById("_to").value
        var _amount = document.getElementById("_amount").value
        var _token = document.getElementById("_token").value
        var data = "0xdbe58c1f".concat(_to.padStart(64, 0)).concat(_amount.padStart(64, 0)).concat(_token.padStart(64, 0))
        transactionData(data, 51919)
    }
</script>
</body>
</html>
